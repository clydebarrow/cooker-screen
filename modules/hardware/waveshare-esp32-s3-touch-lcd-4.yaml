#-------------------------------------------
# Waveshare ESP32-S3 Touch LCD 4" hardware configuration file

esphome:
  name: "${name}"

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  flash_size: 16MB
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    advanced:
      execute_from_psram: true

preferences:
  flash_write_interval: 1min

psram:
  mode: octal
  speed: 80MHz

logger:

api:
  reboot_timeout: 0s
  on_client_connected:
    - lvgl.widget.hide: boot_screen

i2c:
  - id: tp_i2c
    sda: 15
    scl: 7
    scan: true
    frequency: 400kHz

sensor:
  - platform: htu21d
    model: htu21d
    update_interval: 5s
    temperature:
      id: temperature_id
      name: "Temperature"
    humidity:
      id: humidity_id
      name: "Humidity"
      on_value:
        - lvgl.label.update:
            id: humidity_value
            text:
              format: "%.0f"
              args: [x]
    heater:
      id: heater_id
      name: "Heater"

  - platform: copy
    source_id: humidity_id
    id: average_humidity
    name: Average Humidity
    filters:
      - exponential_moving_average:
          alpha: .00069
          send_every: 6

binary_sensor:
  - platform: analog_threshold
    sensor_id: humidity_id
    id: is_humid
    name: High Humidity
    threshold:
      upper: !lambda |-
        return id(average_humidity).state + 10.0;
      lower: !lambda |-
        return id(average_humidity).state + 7.0;
    

pca9554:
  id: expander

touchscreen:
  platform: gt911
  i2c_id: tp_i2c
  id: my_touchscreen
  reset_pin:
    pca9554: expander
    number: 0
  interrupt_pin: 16
  transform:
    swap_xy: true
    mirror_y: false
    mirror_x: true


light:
  - platform: monochromatic
    output: backlight_output
    id: display_backlight
    restore_mode: ALWAYS_ON
    default_transition_length: 4s
    gamma_correct: 1.8

switch:
  - platform: gpio
    id: buzzer
    pin:
      pca9554: expander
      number: 5
      mode:
        output: true

output:
  - platform: ledc
    id: backlight_output
    pin: 44
    frequency: 1220Hz
    inverted: true
    min_power: 15%

spi:
  - id: lcd_spi
    clk_pin: GPIO2
    mosi_pin: GPIO1
    
#external_components:
  #- source: github://pr#9892
    #components: [mipi, mipi_rgb]
    #refresh: 1h

display:
  platform: st7701s
  id: st7701s_disp
  update_interval: never
  auto_clear_enabled: false
  data_rate: 2MHz
  spi_mode: MODE3
  color_order: BGR
  invert_colors: true
  dimensions:
    width: 480
    height: 480
  transform:
    mirror_x: false
    mirror_y: false
  cs_pin: GPIO42
  de_pin: GPIO40
  hsync_pin: GPIO38
  vsync_pin: GPIO39
  pclk_pin: GPIO41
  pclk_frequency: 12MHz
  pclk_inverted: false
  data_pins:
    red:
      - GPIO46       #r1
      - GPIO3        #r2
      - GPIO8      #r3
      - GPIO18       #r4
      - GPIO17       #r5
    green:
      - GPIO14       #g0
      - GPIO13       #g1
      - GPIO12       #g2
      - GPIO11       #g3
      - GPIO10       #g4
      - GPIO9     #g5
    blue:
      - GPIO5        #b1
      - GPIO45       #b2
      - GPIO48       #b3
      - GPIO47       #b4
      - GPIO21       #b5`
#display:
#  platform: mipi_rgb
#  model: "WAVESHARE-4-480x480"
  rotation: 270
